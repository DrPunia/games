<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flippin'</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet">
<style>
    /* --- Main Styles --- */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Calibri, sans-serif;font-size:14px;background:#ffbba7;padding:1rem;display:flex;flex-direction:column;align-items:center; justify-content: center; min-height: 100vh;}
    input{padding:10px;border-radius:6px;border:1px solid #ccc;margin:4px;width:100%;max-width:250px; text-align: center;}
    button{padding:10px 14px;border-radius:6px;background:#2b6ef6;color:#fff;border:0;cursor:pointer;margin:6px;}
    button:hover{background:#1a5ad9;}
    .hidden{display:none!important;}

    /* --- Login and Status --- */
    #login-screen {text-align:center;background:#fff;padding:2rem 2.5rem;border-radius:12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);}
    #login-screen h1 {
        font-family: 'Lilita One', cursive;
        font-size: 4.5rem;
        color: #e74c3c;
        margin-bottom: 0.5rem;
        line-height: 1;
    }
    #login-screen h2 {
        margin-bottom: 1rem;
        font-weight: normal;
        color: #555;
    }
    #status{margin-top:2rem;font-size:1.2rem;font-weight:bold;}
    #timer{font-size:1.1rem;margin-bottom:8px}

    /* --- Game Area --- */
    .game-container{width:100%;max-width:520px;display:flex;flex-direction:column;align-items:center}
    .players{display:flex;justify-content:space-between;width:100%;margin-bottom:8px}
    .player{background:#fff;padding:8px;border-radius:6px;flex:1;margin:0 6px;text-align:center;transition: all 0.3s ease;}
    .player.current-turn{background:#f9e79f;font-weight:bold;border: 2px solid #f39c12; transform: scale(1.05);}

    /* --- Board and Cards --- */
    .board{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;width:100%}
    .card{position:relative;padding-top:100%;border-radius:8px;background:#FFF0E0;cursor:pointer;perspective:800px}
    .card-inner{position:absolute;inset:0;transition:transform 200ms;transform-style:preserve-3d}
    .card.revealed .card-inner{transform:rotateY(180deg)}
    .face,.back{position:absolute;inset:0;border-radius:8px;display:flex;align-items:center;justify-content:center;backface-visibility:hidden}
    .face{transform:rotateY(180deg);flex-direction:column}
    .emoji{font-size:clamp(1.5rem, 7vw, 2.6rem)}

    /* --- Chat Log --- */
    #chat-log-container{width:100%;margin-top:1rem;}
    #chat-log{width:100%;background:#fff;padding:8px;border-radius:6px;max-height:180px;overflow-y:auto;}
    .log-item{font-size:13px;margin-bottom:6px; padding: 4px; border-bottom: 1px solid #eee;}
    .log-item:last-child{border-bottom:none;}

    /* --- Winner Modal --- */
    #winner-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center;
        z-index: 1000;
    }
    .modal-content {
        background: white; padding: 2rem 3rem; border-radius: 10px;
        text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #winner-text { margin-bottom: 1.5rem; font-size: 2rem; color: #333; }
</style>
</head>
<body>
    
    <div id="login-screen">
        <h1>Flippin'</h1>
        <h2>Enter Your Name</h2>
        <input type="text" id="name-input" placeholder="Your Name" maxlength="15">
        <button id="join-game-btn">Join Game</button>
    </div>

    <div id="status" class="hidden">Connecting…</div>

    <div class="game-container hidden" id="game">
        <div id="timer">Time: 03:00</div>
        <div class="players" id="players"></div>
        <div id="pairsFound">Pairs found: 0 / 10</div>
        <div class="board" id="board"></div>
        <div id="chat-log-container">
            <h3>Chat</h3>
            <div id="chat-log"></div>
        </div>
        <button id="btnRematch">Request Rematch</button>
    </div>

    <div id="winner-modal" class="hidden">
        <div class="modal-content">
            <h2 id="winner-text"></h2>
            <button id="play-again-btn">Play Again</button>
        </div>
    </div>

<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script>
    const SOCKET_SERVER_URL = 'https://flippin-server.onrender.com';
    let socket;

    // --- DOM Elements ---
    const loginScreen = document.getElementById('login-screen');
    const statusDiv = document.getElementById('status');
    const gameDiv = document.getElementById('game');
    const joinButton = document.getElementById('join-game-btn');
    const nameInput = document.getElementById('name-input');
    const btnRematch = document.getElementById('btnRematch');
    const winnerModal = document.getElementById('winner-modal');
    const playAgainBtn = document.getElementById('play-again-btn');

    // --- Event Listeners ---
    joinButton.addEventListener('click', () => {
        const playerName = nameInput.value.trim();
        if (!playerName) {
            alert('Please enter your name!');
            return;
        }
        loginScreen.classList.add('hidden');
        statusDiv.classList.remove('hidden');
        connectToServer(playerName);
    });
    
    btnRematch.onclick = () => socket.emit('rematch', {}, res => {
        if (res && !res.ok && res.error) alert('Rematch failed: ' + res.error);
    });

    playAgainBtn.onclick = () => {
        winnerModal.classList.add('hidden');
        btnRematch.click();
    };

    // --- Socket Logic ---
    function connectToServer(playerName) {
        socket = io(SOCKET_SERVER_URL, {
            query: { name: playerName },
            transports: ['websocket', 'polling']
        });

        socket.on('connect_error', err => {
            console.error('Connection error:', err);
            statusDiv.textContent = 'Cannot connect to server.';
        });

        socket.on('connect', () => {
            statusDiv.textContent = 'Connected — waiting for opponent…';
        });

        socket.on('state', renderState);
        socket.on('timer', secs => {
            document.getElementById('timer').textContent = `Time: ${formatTime(secs)}`;
        });
        
        socket.on('gameOver', ({ winnerName, isTie }) => {
            const winnerText = document.getElementById('winner-text');
            if (isTie) {
                winnerText.textContent = "Oops it's a tie!";
            } else {
                winnerText.textContent = `${winnerName} won!`;
            }
            winnerModal.classList.remove('hidden');
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
        });

        socket.on('gameReset', () => {
            winnerModal.classList.add('hidden');
        });

        socket.on('askQuestion', ({ remaining }) => {
            if (remaining > 0) {
                const q = prompt(`You found a match! Ask a question (${remaining} left):`);
                socket.emit('askQuestion', { text: q || '' });
            } else {
                alert("You have no questions left!");
                socket.emit('answerQuestion', { text: '(skipped)' });
            }
        });

        socket.on('questionForAnswer', ({ from, text }) => {
            const ans = prompt(`${from} asks: "${text}". Your answer:`);
            socket.emit('answerQuestion', { text: ans || '' });
        });
    }

    // --- Rendering Logic ---
    function renderState(s) {
        statusDiv.classList.add('hidden');
        gameDiv.classList.remove('hidden');

        const playersEl = document.getElementById('players');
        playersEl.innerHTML = '';
        s.players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'player';
            if (i === s.currentPlayer) div.classList.add('current-turn');
            div.innerHTML = `<strong>${p.name}</strong><br>Matches: ${p.matches}<br>Questions Asked: ${p.asked || 0}/5`;
            playersEl.appendChild(div);
        });

        document.getElementById('pairsFound').textContent = `Pairs found: ${(s.players[0]?.matches||0) + (s.players[1]?.matches||0)} / 10`;

        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        s.cards.forEach((c, idx) => {
            const card = document.createElement('div');
            card.className = 'card' + ((c.revealed || c.matched) ? ' revealed' : '');
            card.innerHTML = `<div class="card-inner"><div class="back"></div><div class="face"><div class="emoji">${c.emoji}</div></div></div>`;
            if (!c.revealed && !c.matched) {
                card.addEventListener('click', () => {
                    socket.emit('flip', { idx }, res => { if (res?.error) console.error(res.error); });
                });
            }
            boardEl.appendChild(card);
        });

        const chatLogEl = document.getElementById('chat-log');
        chatLogEl.innerHTML = '';
        (s.chatLog || []).forEach(item => {
            const d = document.createElement('div');
            d.className = 'log-item';
            d.innerHTML = `<strong>${item.by}:</strong> ${escapeHTML(item.text)}`;
            chatLogEl.appendChild(d);
        });
        chatLogEl.scrollTop = chatLogEl.scrollHeight;
    }

    // --- Utility Functions ---
    function formatTime(sec) {
        const m = String(Math.floor(sec / 60)).padStart(2, '0');
        const s = String(sec % 60).padStart(2, '0');
        return `${m}:${s}`;
    }

    function escapeHTML(str) {
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }
</script>
</body>
</html>
