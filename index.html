<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flippin — Real-time</title>
<style>
  /* minimal styles (same as before, mobile-optimized) */
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Calibri, sans-serif;font-size:14px;background:#ffbba7;padding:1rem;display:flex;flex-direction:column;align-items:center}
  h1{font-size:1.4rem;margin-bottom:0.8rem}
  .controls{background:#fff;padding:0.6rem;border-radius:8px;width:100%;max-width:520px;margin-bottom:0.8rem;text-align:center}
  input{padding:8px;border-radius:6px;border:1px solid #ccc;margin:4px}
  button{padding:8px 10px;border-radius:6px;background:#2b6ef6;color:#fff;border:0;cursor:pointer;margin-left:6px}
  #timer{font-size:1.1rem;margin-bottom:8px}
  .game-container{width:100%;max-width:520px;display:flex;flex-direction:column;align-items:center}
  .players{display:flex;justify-content:space-between;width:100%;margin-bottom:8px}
  .player{background:#fff;padding:8px;border-radius:6px;flex:1;margin:0 6px;text-align:center}
  .board{display:grid;grid-template-columns:repeat(auto-fit,minmax(60px,1fr));gap:8px;width:100%}
  .card{position:relative;padding-top:100%;border-radius:8px;background:#FFF0E0;cursor:pointer;perspective:800px}
  .card-inner{position:absolute;inset:0;transition:transform 300ms;transform-style:preserve-3d}
  .card.revealed .card-inner{transform:rotateY(180deg)}
  .face,.back{position:absolute;inset:0;border-radius:8px;display:flex;align-items:center;justify-content:center;backface-visibility:hidden}
  .face{transform:rotateY(180deg);flex-direction:column}
  .emoji{font-size:2.6rem}
  #log{width:100%;margin-top:8px;background:#fff;padding:8px;border-radius:6px;max-height:180px;overflow:auto}
  .log-item{font-size:13px;margin-bottom:6px}
</style>
</head>
<body>
  <h1>Flippin (Real-time)</h1>

  <div id="status">Connecting…</div>
  <div id="timer">Time: 03:00</div>

  <div class="game-container" id="game" style="display:none">
    <div class="players" id="players"></div>
    <div id="pairsFound">Pairs found: 0 / 10</div>
    <div class="board" id="board"></div>
    <div id="log"></div>
    <button id="btnRematch">Rematch</button>
  </div>

  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <script>
    const SOCKET_SERVER_URL = 'https://flippin-server.onrender.com';
    const socket = io(SOCKET_SERVER_URL, { transports: ['websocket','polling'] });

    socket.on('connect_error', err => {
      console.error('Connection error:', err);
      alert('Cannot connect to server.');
      document.getElementById('status').textContent = 'Connection error';
    });

    socket.on('connect', () => {
      document.getElementById('status').textContent = 'Connected — waiting for opponent…';
    });

    const btnRematch = document.getElementById('btnRematch');
    btnRematch.onclick = () => {
      socket.emit('rematch', {}, res => {
        if (!res.ok && res.error) alert('Rematch failed: ' + res.error);
      });
    };

    socket.on('roomAssigned', ({ roomId }) => {
      document.getElementById('status').textContent = `In default room`;
      console.log('Assigned to default room:', roomId);
    });

    socket.on('state', renderState); // handle UI updates
    socket.on('timer', secs => {
      document.getElementById('timer').textContent = `Time: ${formatTime(secs)}`;
    });

    socket.on('timerPaused', () => log('Timer paused'));
    socket.on('timeUp', () => alert('Time is up!'));

    socket.on('askQuestion', ({ remaining }) => {
      const q = prompt(`Ask a question (remaining: ${remaining}):`);
      socket.emit('askQuestion', { text: q || '' });
    });

    socket.on('questionForAnswer', ({ from, text }) => {
      const ans = prompt(`${from} asks: "${text}". Your answer:`);
      socket.emit('answerQuestion', { text: ans || '' });
    });

    socket.on('questionAnswered', ({ by, text }) => {
      log(`${by} answered: ${text}`);
    });

    function renderState(s) {
      document.getElementById('status').textContent = '';
      document.getElementById('game').style.display = 'flex';

      const playersEl = document.getElementById('players');
      playersEl.innerHTML = '';
      s.players.forEach((p,i) => {
        const div = document.createElement('div');
        div.className = 'player';
        if (i === s.currentPlayer) div.style.outline = '2px solid #f39c12';
        div.innerHTML = `<strong>${p.name}</strong><br>Matches: ${p.matches}<br>Q left: ${5 + (p.extra||0) - (p.asked||0)}`;
        playersEl.appendChild(div);
      });

      document.getElementById('pairsFound').textContent = `Pairs found: ${(s.players[0]?.matches||0) + (s.players[1]?.matches||0)} / 10`;

      const boardEl = document.getElementById('board');
      boardEl.innerHTML = '';
      s.cards.forEach((c, idx) => {
        const card = document.createElement('div');
        card.className = 'card' + ((c.revealed||c.matched) ? ' revealed' : '');
        card.innerHTML = `<div class="card-inner"><div class="back"></div><div class="face"><div class="emoji">${c.emoji}</div></div></div>`;
        if (!c.revealed && !c.matched) {
          card.addEventListener('click', () => {
            socket.emit('flip', { idx }, res => { if (res?.error) log(res.error); });
          });
        }
        boardEl.appendChild(card);
      });

      const logEl = document.getElementById('log');
      logEl.innerHTML = '';
      (s.log || []).slice(0, 12).forEach(item => { log(item.text); });
    }

    function log(msg) {
      const d = document.createElement('div');
      d.className = 'log-item';
      d.textContent = msg;
      document.getElementById('log').prepend(d);
    }

    function formatTime(sec) {
      const m = String(Math.floor(sec/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      return `${m}:${s}`;
    }
  </script>
</body>

</html>
